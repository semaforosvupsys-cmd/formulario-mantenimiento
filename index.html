<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mantenimiento Semaf√≥rico Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <style>
        * { box-sizing: border-box; }
        body { background: #0f172a; padding: 15px; font-family: system-ui, -apple-system, sans-serif; color: #1e293b; }
        .card { background: white; max-width: 450px; margin: auto; padding: 25px; border-radius: 20px; shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #0f172a; font-size: 1.5rem; text-align: center; }
        label { font-weight: 600; margin-top: 15px; display: block; font-size: 0.9rem; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 6px; border-radius: 10px; border: 1px solid #d1d5db; font-size: 16px; }
        button { background: #059669; color: white; font-weight: bold; border: none; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        button:disabled { background: #9ca3af; }
        #msg { text-align: center; margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 8px; }
        .offline-alert { background: #f59e0b; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; display: none; font-size: 0.85rem; }
        .gps-info { font-size: 0.75rem; color: #64748b; margin-top: 4px; }
    </style>
</head>
<body>

<div class="card">
    <div style="text-align:center; margin-bottom:15px">
        <img src="icons/logo.png" style="max-width:100px" onerror="this.style.display='none'">
    </div>

    <div id="offlineAlert" class="offline-alert">‚ö†Ô∏è Tienes registros pendientes por subir</div>

    <h2>üö¶ Registro Mantenimiento</h2>

    <form id="form">
        <label>Fecha</label>
        <input type="date" id="fecha" required>

        <label>Intersecci√≥n / Direcci√≥n</label>
        <input type="text" id="direccion" placeholder="Ej: Calle 10 con Cra 5" required>

        <label>Tipo de falla</label>
        <select id="falla" required>
            <option value="">Seleccione</option>
            <option value="Lampara">L√°mpara</option>
            <option value="Cableado">Cableado</option>
            <option value="Controlador">Controlador</option>
            <option value="Estructural">Estructural</option>
        </select>

        <label>Actividad realizada</label>
        <select id="actividad" required>
            <option value="">Seleccione actividad</option>
        </select>

        <label>Observaciones</label>
        <textarea id="observaciones" rows="2"></textarea>

        <label>T√©cnico</label>
        <select id="tecnico" required>
            <option value="">Seleccione</option>
            <option>Guanerge Salcedo</option>
            <option>Luis Gutierrez</option>
            <option>Juan Bola√±os</option>
            <option>Jose Colmenares</option>
            <option>William Orcasita</option>
        </select>

        <label>Foto ANTES</label>
        <input type="file" id="fotoAntes" accept="image/*" capture="camera">

        <label>Foto DESPU√âS</label>
        <input type="file" id="fotoDespues" accept="image/*" capture="camera" required>

        <div id="gpsStatus" class="gps-info">üìç Buscando ubicaci√≥n...</div>

        <button type="submit" id="btnGuardar">
            <span id="btnTexto">Guardar Registro</span>
            <span id="spinner" style="display:none"> ‚è≥</span>
        </button>

        <div id="msg"></div>
    </form>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUIkBk8Ymgm1YNSavmykxfeLd_ifSyRg5tZDexDrFptuqsVsqQ3hhYW6T91Zr8Tta-/exec"; 
let coords = "No obtenida";

/* === L√ìGICA GPS === */
navigator.geolocation.getCurrentPosition(
    p => { coords = `${p.coords.latitude},${p.coords.longitude}`; document.getElementById("gpsStatus").textContent = "üìç Ubicaci√≥n fijada"; },
    () => { document.getElementById("gpsStatus").textContent = "üìç GPS no disponible"; }
);

/* === ACTIVIDADES DIN√ÅMICAS === */
const actividades = {
    Lampara:["Vehicular","Peatonal"],
    Cableado:["Vehicular","Peatonal","Acometida el√©ctrica"],
    Controlador:["Tarjetas","Reinicio","Breaker","Comunicaci√≥n","UPS","Fusible"],
    Estructural:["Postes T1","Postes T2","Sem√°foros S1","Sem√°foros S2","Bases","Anclaje","Tornillos"]
};

document.getElementById("falla").onchange = (e) => {
    const actSel = document.getElementById("actividad");
    actSel.innerHTML = "<option value=''>Seleccione actividad</option>";
    if(actividades[e.target.value]) {
        actividades[e.target.value].forEach(a => {
            let o = document.createElement("option"); o.value = o.textContent = a; actSel.appendChild(o);
        });
    }
};

/* === COMPRESI√ìN DE IMAGEN === */
async function procesarFoto(file) {
    if(!file) return "";
    return new Promise(res => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const MAX = 1000;
                let w = img.width, h = img.height;
                if (w > h && w > MAX) { h *= MAX/w; w = MAX; }
                else if (h > MAX) { w *= MAX/h; h = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                res(canvas.toDataURL("image/jpeg", 0.7).split(",")[1]);
            };
        };
    });
}

/* === GESTI√ìN OFFLINE === */
function actualizarAlerta() {
    const p = JSON.parse(localStorage.getItem("pendientes") || "[]");
    document.getElementById("offlineAlert").style.display = p.length > 0 ? "block" : "none";
}

const form = document.getElementById("form");
form.onsubmit = async e => {
    e.preventDefault();
    const btn = document.getElementById("btnGuardar");
    btn.disabled = true;
    document.getElementById("btnTexto").textContent = "Procesando...";
    
    const datos = {
        id: "MNT-" + Date.now().toString(36),
        fecha: document.getElementById("fecha").value,
        direccion: document.getElementById("direccion").value,
        falla: document.getElementById("falla").value,
        actividad: document.getElementById("actividad").value,
        observaciones: document.getElementById("observaciones").value,
        tecnico: document.getElementById("tecnico").value,
        coords: coords,
        fotoAntes: await procesarFoto(document.getElementById("fotoAntes").files[0]),
        fotoDespues: await procesarFoto(document.getElementById("fotoDespues").files[0])
    };

    if(!navigator.onLine) {
        const p = JSON.parse(localStorage.getItem("pendientes") || "[]");
        p.push(datos);
        localStorage.setItem("pendientes", JSON.stringify(p));
        finalizar("üìµ Guardado local (sin internet)", "#f59e0b");
    } else {
        try {
            const r = await fetch(WEB_APP_URL, { method:"POST", body: JSON.stringify(datos) });
            const t = await r.text();
            if(t === "OK") finalizar("‚úÖ Enviado con √©xito", "#059669");
            else throw t;
        } catch(e) {
            const p = JSON.parse(localStorage.getItem("pendientes") || "[]");
            p.push(datos);
            localStorage.setItem("pendientes", JSON.stringify(p));
            finalizar("‚ö†Ô∏è Error de red, guardado local", "#f59e0b");
        }
    }
};

function finalizar(m, c) {
    const msg = document.getElementById("msg");
    msg.textContent = m; msg.style.color = c;
    form.reset();
    btnGuardar.disabled = false;
    document.getElementById("btnTexto").textContent = "Guardar Registro";
    actualizarAlerta();
}

window.addEventListener("online", async () => {
    let p = JSON.parse(localStorage.getItem("pendientes") || "[]");
    if (!p.length) return;

    console.log("Detectada conexi√≥n. Intentando subir " + p.length + " pendientes...");

    // Creamos una copia para trabajar y evitar errores de √≠ndice al borrar
    const pendientesActualizados = [...p];
    const exitosos = [];

    for (let i = 0; i < pendientesActualizados.length; i++) {
        try {
            const r = await fetch(WEB_APP_URL, { 
                method: "POST", 
                body: JSON.stringify(pendientesActualizados[i]) 
            });
            const t = await r.text();
            
            // Si el servidor responde OK o DUPLICADO, lo consideramos procesado
            if (t === "OK" || t === "DUPLICADO") {
                exitosos.push(i);
            }
        } catch (e) {
            console.error("Error subiendo registro pendiente", e);
        }
    }

    // Filtramos los que NO fueron exitosos para mantenerlos en pendientes
    const restantes = pendientesActualizados.filter((_, index) => !exitosos.includes(index));
    localStorage.setItem("pendientes", JSON.stringify(restantes));
    actualizarAlerta();
});

actualizarAlerta();
if("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");
</script>
</body>
</html>
