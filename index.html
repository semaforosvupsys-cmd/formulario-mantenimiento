<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mantenimiento Semaf√≥rico VUP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #0f172a; color: #fff; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        
        /* Men√∫ Principal */
        .menu-grid { display: grid; gap: 15px; margin-top: 20px; }
        .menu-btn { 
            padding: 25px; border-radius: 15px; border: none; font-weight: bold; 
            font-size: 1.1rem; cursor: pointer; color: white; text-align: left;
            transition: 0.3s; display: flex; align-items: center; justify-content: space-between;
        }
        .menu-btn:active { transform: scale(0.98); }
        .btn-reparacion { background: #059669; border-left: 10px solid #047857; }
        .btn-pendiente { background: #3b82f6; border-left: 10px solid #1d4ed8; }
        .btn-preventivo { background: #8b5cf6; border-left: 10px solid #6d28d9; }

        /* Formulario */
        .card { background: white; color: #1e293b; padding: 20px; border-radius: 20px; display: none; margin-top: 10px; }
        .active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        label { display: block; margin-top: 12px; font-weight: bold; font-size: 0.9rem; color: #475569; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 16px; }
        
        .btn-send { background: #0f172a; color: white; border: none; padding: 16px; width: 100%; border-radius: 10px; margin-top: 25px; font-weight: bold; cursor: pointer; }
        .btn-back { background: #f1f5f9; color: #475569; border: none; padding: 10px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; font-weight: bold; }
        
        .check-item { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; margin-top: 5px; border: 1px solid #e2e8f0; }
        .check-item input { width: auto; margin: 0; }
        .offline-alert { background: #f59e0b; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="offlineAlert" class="offline-alert">‚ö†Ô∏è Tienes reportes pendientes por subir</div>

    <div id="menuPrincipal">
        <h2 style="text-align: center; margin-bottom: 30px;">Gesti√≥n de Tr√°nsito</h2>
        <div class="menu-grid">
            <button class="menu-btn btn-reparacion" onclick="abrirForm('REPARACION')">üõ†Ô∏è REGISTRAR ARREGLO <span>‚Üí</span></button>
            <button class="menu-btn btn-pendiente" onclick="abrirForm('INVENTARIO_FALLA')">üìù INVENTARIO DE FALLA <span>‚Üí</span></button>
            <button class="menu-btn btn-preventivo" onclick="abrirForm('PREVENTIVO')">‚úÖ MANT. PREVENTIVO <span>‚Üí</span></button>
        </div>
    </div>

    <div id="pantallaForm" class="card">
        <button class="btn-back" onclick="irAlMenu()">‚Üê Volver al Men√∫</button>
        <h2 id="tituloSeccion" style="margin:0; color: #0f172a;"></h2>
        
        <form id="mainForm">
            <input type="hidden" id="tipoRegistro">

            <label>Fecha del Trabajo</label>
            <input type="date" id="fecha" required>

            <label>T√©cnico</label>
            <select id="tecnico" required>
                <option value="">Seleccione T√©cnico</option>
                <option>Luis Gutierrez</option>
                <option>Guanerge Salcedo</option>
                <option>Juan Bola√±os</option>
                <option>Jose Colmenares</option>
                <option>William Orcasita</option>
            </select>

            <label>Ubicaci√≥n / Intersecci√≥n</label>
            <input type="text" id="direccion" placeholder="Ej: Av. Fundaci√≥n con Cra 12" required>

            <div id="bloqueFallas">
                <label>Tipo de Falla</label>
                <select id="falla">
                    <option value="">Seleccione Falla</option>
                    <option value="Lampara">L√°mpara</option>
                    <option value="Cableado">Cableado</option>
                    <option value="Controlador">Controlador</option>
                    <option value="Estructural">Estructural</option>
                    <option value="Radar de Velocidad">Radar de Velocidad</option>
                </select>

                <div id="bloqueActividad">
                    <label>Actividad Realizada</label>
                    <select id="actividad">
                        <option value="">Seleccione Actividad</option>
                    </select>
                </div>
            </div>

            <div id="bloquePrioridad" style="display:none">
                <label>Prioridad del Arreglo</label>
                <select id="prioridad">
                    <option value="Baja">Baja</option>
                    <option value="Media">Media</option>
                    <option value="ALTA / URGENTE">ALTA / URGENTE</option>
                </select>
            </div>

            <div id="bloquePreventivo" style="display:none">
                <label>Checklist de Rutina</label>
                <div class="check-item"><input type="checkbox" id="chkLimpieza"> Limpieza de √≥pticas</div>
                <div class="check-item"><input type="checkbox" id="chkAjuste"> Ajuste de torniller√≠a</div>
                <div class="check-item"><input type="checkbox" id="chkVoltaje"> Medici√≥n de Voltaje</div>
            </div>

            <label>Observaciones</label>
            <textarea id="observaciones" rows="2" placeholder="Notas adicionales..."></textarea>

            <div id="bloqueFotos">
                <label>Foto Antes / Evidencia</label>
                <input type="file" id="foto1" accept="image/*" capture="camera">
                
                <div id="foto2Contenedor">
                    <label>Foto Despu√©s (Arreglo Terminado)</label>
                    <input type="file" id="foto2" accept="image/*" capture="camera">
                </div>
            </div>

            <button type="submit" class="btn-send" id="btnGuardar">GUARDAR REGISTRO</button>
            <div id="msgStatus" style="text-align:center; margin-top:15px; font-weight:bold"></div>
        </form>
    </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUIkBk8Ymgm1YNSavmykxfeLd_ifSyRg5tZDexDrFptuqsVsqQ3hhYW6T91Zr8Tta-/exec"; 
let coords = "Buscando GPS...";

navigator.geolocation.getCurrentPosition(p => coords = `${p.coords.latitude},${p.coords.longitude}`);

const diccionarioActividades = {
    "Lampara": ["Vehicular", "Peatonal"],
    "Cableado": ["Vehicular", "Peatonal", "Acometida el√©ctrica"],
    "Controlador": ["Tarjetas", "Reinicio", "Breaker", "Comunicaci√≥n", "UPS", "Fusible"],
    "Estructural": ["Postes T1", "Postes T2", "Sem√°foros S1", "Sem√°foros S2", "Bases", "Anclaje", "Tornillos"],
    "Radar de Velocidad": ["Bater√≠as", "Panel Solar", "Panel Electr√≥nico"]
};

document.getElementById("falla").onchange = (e) => {
    const actSel = document.getElementById("actividad");
    const falla = e.target.value;
    actSel.innerHTML = "<option value=''>Seleccione Actividad</option>";
    if(diccionarioActividades[falla]) {
        diccionarioActividades[falla].forEach(a => {
            let o = document.createElement("option"); o.value = o.textContent = a; actSel.appendChild(o);
        });
    }
};

function abrirForm(tipo) {
    document.getElementById("menuPrincipal").style.display = "none";
    document.getElementById("pantallaForm").classList.add("active");
    document.getElementById("tipoRegistro").value = tipo;
    document.getElementById("tituloSeccion").textContent = tipo.replace(/_/g, ' ');
    document.getElementById("bloqueFallas").style.display = (tipo !== "PREVENTIVO") ? "block" : "none";
    document.getElementById("bloqueActividad").style.display = (tipo === "REPARACION") ? "block" : "none";
    document.getElementById("bloquePrioridad").style.display = (tipo === "INVENTARIO_FALLA") ? "block" : "none";
    document.getElementById("bloquePreventivo").style.display = (tipo === "PREVENTIVO") ? "block" : "none";
    document.getElementById("foto2Contenedor").style.display = (tipo === "INVENTARIO_FALLA") ? "none" : "block";
}

function irAlMenu() {
    document.getElementById("pantallaForm").classList.remove("active");
    document.getElementById("menuPrincipal").style.display = "block";
}

async function procesarFoto(file) {
    if(!file) return "";
    return new Promise(res => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const MAX = 1000;
                let w = img.width, h = img.height;
                if (w > h && w > MAX) { h *= MAX/w; w = MAX; }
                else if (h > MAX) { w *= MAX/h; h = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                res(canvas.toDataURL("image/jpeg", 0.7).split(",")[1]);
            };
        };
    });
}

function actualizarAlerta() {
    const p = JSON.parse(localStorage.getItem("vup_pendientes") || "[]");
    document.getElementById("offlineAlert").style.display = p.length > 0 ? "block" : "none";
}

document.getElementById("mainForm").onsubmit = async e => {
    e.preventDefault();
    const btn = document.getElementById("btnGuardar");
    const msg = document.getElementById("msgStatus");
    btn.disabled = true;
    msg.textContent = "‚è≥ Procesando...";

    const datos = {
        id: "ID-" + Date.now().toString(36).toUpperCase(),
        tipo: document.getElementById("tipoRegistro").value,
        fecha: document.getElementById("fecha").value,
        tecnico: document.getElementById("tecnico").value,
        direccion: document.getElementById("direccion").value,
        falla: document.getElementById("falla").value,
        actividad: document.getElementById("actividad").value,
        prioridad: document.getElementById("prioridad").value,
        observaciones: document.getElementById("observaciones").value,
        coords: coords,
        preventivo: {
            limpieza: document.getElementById("chkLimpieza").checked ? "SI" : "NO",
            ajuste: document.getElementById("chkAjuste").checked ? "SI" : "NO",
            voltaje: document.getElementById("chkVoltaje").checked ? "SI" : "NO"
        },
        foto1: await procesarFoto(document.getElementById("foto1").files[0]),
        foto2: await procesarFoto(document.getElementById("foto2").files[0])
    };

    if(!navigator.onLine) {
        guardarLocal(datos);
        finalizarEnvio("üìµ Guardado en el tel√©fono (Sin Internet)", "#f59e0b");
    } else {
        try {
            const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(datos) });
            const txt = await res.text();
            if(txt === "OK") finalizarEnvio("‚úÖ ¬°Enviado con √©xito!", "#059669");
            else throw "Error";
        } catch(err) {
            guardarLocal(datos);
            finalizarEnvio("‚ö†Ô∏è Error de red, guardado localmente", "#f59e0b");
        }
    }
};

function guardarLocal(d) {
    const p = JSON.parse(localStorage.getItem("vup_pendientes") || "[]");
    p.push(d);
    localStorage.setItem("vup_pendientes", JSON.stringify(p));
}

function finalizarEnvio(m, c) {
    const msg = document.getElementById("msgStatus");
    msg.style.color = c;
    msg.textContent = m;
    setTimeout(() => {
        document.getElementById("mainForm").reset();
        irAlMenu();
        msg.textContent = "";
        document.getElementById("btnGuardar").disabled = false;
        actualizarAlerta();
    }, 2500);
}

// Sincronizaci√≥n autom√°tica al volver el internet
window.addEventListener("online", async () => {
    let p = JSON.parse(localStorage.getItem("vup_pendientes") || "[]");
    if (!p.length) return;
    for (let i = 0; i < p.length; i++) {
        try {
            const r = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(p[i]) });
            if (await r.text() === "OK") {
                p.splice(i, 1);
                i--;
            }
        } catch (e) {}
    }
    localStorage.setItem("vup_pendientes", JSON.stringify(p));
    actualizarAlerta();
});

actualizarAlerta();
if("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");
</script>
</body>
</html>
