<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mantenimiento Semaf√≥rico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#059669">

<style>
*{box-sizing:border-box}
body{background:#0f172a;padding:15px;font-family:system-ui}
.card{background:white;max-width:420px;margin:auto;padding:20px;border-radius:16px}
label{font-weight:600;margin-top:12px;display:block}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #d1d5db;
}
button{
  background:#059669;
  color:white;
  font-weight:bold;
  border:none;
}
button:disabled{
  background:#9ca3af;
}
#msg{text-align:center;margin-top:10px;font-weight:bold}
</style>
</head>

<body>

<div class="card">

<div style="text-align:center;margin-bottom:10px">
  <img src="icons/logo.png" style="max-width:120px">
</div>

<h2>üö¶ Registro Mantenimiento</h2>

<form id="form">

<label>Fecha</label>
<input type="date" id="fecha" required>

<label>Intersecci√≥n</label>
<input type="text" id="direccion" required>

<label>Tipo de falla</label>
<select id="falla" required>
  <option value="">Seleccione</option>
  <option value="Lampara">L√°mpara</option>
  <option value="Cableado">Cableado</option>
  <option value="Controlador">Controlador</option>
  <option value="Estructural">Estructural</option>
</select>

<label>Actividad realizada</label>
<select id="actividad" required disabled>
  <option value="">Seleccione actividad</option>
</select>

<label>Observaciones</label>
<input type="text" id="observaciones">

<label>T√©cnico</label>
<select id="tecnico" required>
  <option value="">Seleccione</option>
  <option>Guanerge Salcedo</option>
  <option>Luis Gutierrez</option>
  <option>Juan Bola√±os</option>
  <option>Jose Colmenares</option>
  <option>William Orcasita</option>
</select>

<label>Foto ANTES (opcional)</label>
<input type="file" id="fotoAntes" accept="image/*" capture="environment">

<label>Foto DESPU√âS (obligatoria)</label>
<input type="file" id="fotoDespues" accept="image/*" capture="environment" required>

<button type="submit" id="btnGuardar">
  <span id="btnTexto">Guardar</span>
  <span id="spinner" style="display:none"> ‚è≥</span>
</button>

<div id="msg"></div>

</form>
</div>

<script>
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbwZbqPJsbS_0NWUguqAojgRciK9QOpeCTwopoA0w8qKx0awo9Pi3ZzIl5xrI0_CNC7h/exec";

/* üîê CANDADO */
let enviando = false;

/* üìå REFERENCIAS */
const form = document.getElementById("form");
const falla = document.getElementById("falla");
const actividad = document.getElementById("actividad");
const btnGuardar = document.getElementById("btnGuardar");
const btnTexto = document.getElementById("btnTexto");
const spinner = document.getElementById("spinner");
const msg = document.getElementById("msg");

const fecha = document.getElementById("fecha");
const direccion = document.getElementById("direccion");
const observaciones = document.getElementById("observaciones");
const tecnico = document.getElementById("tecnico");
const fotoAntes = document.getElementById("fotoAntes");
const fotoDespues = document.getElementById("fotoDespues");

/* üö¶ ACTIVIDADES */
const actividades = {
  Lampara:["Vehicular","Peatonal"],
  Cableado:["Vehicular","Peatonal","Acometida el√©ctrica"],
  Controlador:["Tarjetas","Reinicio","Breaker","Comunicaci√≥n","UPS","Fusible"],
  Estructural:["Postes T1","Postes T2","Sem√°foros S1","Sem√°foros S2","Bases","Anclaje","Tornillos"]
};

/* üîÑ ACTIVAR ACTIVIDAD */
falla.addEventListener("change", () => {
  actividad.innerHTML = "<option value=''>Seleccione actividad</option>";
  actividad.disabled = true;

  if (!falla.value) return;

  actividades[falla.value].forEach(a => {
    const o = document.createElement("option");
    o.value = a;
    o.textContent = a;
    actividad.appendChild(o);
  });

  actividad.disabled = false;
});

/* üÜî ID CORTO Y CLARO */
function generarID(){
  const d = new Date();
  const fecha = d.toISOString().slice(2,10).replace(/-/g,"");
  const hora = d.toTimeString().slice(0,8).replace(/:/g,"");
  const rnd = Math.floor(Math.random()*900)+100;
  return `MNT-${fecha}-${hora}-${rnd}`;
}

/* üì∏ LEER FOTO (SIEMPRE) */
function leer(f){
  return new Promise(r=>{
    if(!f) return r("");
    const fr = new FileReader();
    fr.onload = ()=>r(fr.result.split(",")[1]);
    fr.readAsDataURL(f);
  });
}

/* üíæ GUARDAR OFFLINE */
function guardarOffline(data){
  const p = JSON.parse(localStorage.getItem("pendientes")||"[]");
  p.push(data);
  localStorage.setItem("pendientes",JSON.stringify(p));
}

/* üì§ SUBMIT */
form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(enviando) return;

  enviando = true;
  btnGuardar.disabled = true;
  btnTexto.textContent = "Enviando...";
  spinner.style.display = "inline";
  msg.textContent = "";

  /* üì∏ LEER FOTOS ANTES DE TODO */
  form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(enviando) return;

  enviando = true;
  btnGuardar.disabled = true;
  btnTexto.textContent = "Enviando...";
  spinner.style.display = "inline";
  msg.textContent = "";

  const datos = {
    id: generarID(),
    fecha: fecha.value,
    direccion: direccion.value,
    falla: falla.value,
    actividad: actividad.value,
    observaciones: observaciones.value,
    tecnico: tecnico.value,
    fotoAntes: fotoAntes.files[0] || null,
    fotoDespues: fotoDespues.files[0]
  };

  /* üìµ SIN INTERNET ‚Üí SALIR R√ÅPIDO */
  if(!navigator.onLine){
    guardarOffline(datos);
    finalizar("üìµ Guardado sin internet","orange");
    return;
  }

  /* üì∂ CON INTERNET ‚Üí CONVERTIR FOTOS */
  datos.fotoAntes = await leer(datos.fotoAntes);
  datos.fotoDespues = await leer(datos.fotoDespues);

  try{
    await fetch(WEB_APP_URL,{
      method:"POST",
      body:JSON.stringify(datos)
    });
    finalizar("‚úÖ Registro enviado","green");
  }catch{
    guardarOffline(datos);
    finalizar("‚ö†Ô∏è Error. Guardado localmente","orange");
  }
});

/* üîÅ REENV√çO OFFLINE (SIN DUPLICAR) */
window.addEventListener("online", async ()=>{
  let pendientes = JSON.parse(localStorage.getItem("pendientes")||"[]");
  if(!pendientes.length) return;

  const restantes=[];
  for(const p of pendientes){
    try{
      await fetch(WEB_APP_URL,{
        method:"POST",
        body:JSON.stringify(p)
      });
    }catch{
      restantes.push(p);
    }
  }
  localStorage.setItem("pendientes",JSON.stringify(restantes));
});

/* üîÑ FINALIZAR */
function finalizar(texto,color){
  msg.textContent = texto;
  msg.style.color = color;
  form.reset();
  actividad.innerHTML="<option value=''>Seleccione actividad</option>";
  actividad.disabled = true;
  btnGuardar.disabled = false;
  btnTexto.textContent = "Guardar";
  spinner.style.display = "none";
  enviando = false;
}
</script>

</body>
</html>

