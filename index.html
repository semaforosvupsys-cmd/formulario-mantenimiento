<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mantenimiento Semaf√≥rico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- üì± CONFIGURACI√ìN PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#059669">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
*{box-sizing:border-box}
body{background:#0f172a;padding:15px;font-family:system-ui}
.card{background:white;max-width:420px;margin:auto;padding:20px;border-radius:16px}
label{font-weight:600;margin-top:12px;display:block}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #d1d5db;
}
button{
  background:#059669;
  color:white;
  font-weight:bold;
  border:none;
}
button:disabled{
  background:#9ca3af;
  cursor:not-allowed;
}
#msg{text-align:center;margin-top:10px;font-weight:bold}
</style>
</head>

<body>

<div class="card">

<div style="text-align:center;margin-bottom:10px">
  <img src="icons/logo.png" style="max-width:120px">
</div>

<h2>üö¶ Registro Mantenimiento</h2>

<form id="form">

<label>Fecha</label>
<input type="date" id="fecha" required>

<label>Intersecci√≥n</label>
<input type="text" id="direccion" required>

<label>Tipo de falla</label>
<select id="falla" required>
<option value="">Seleccione</option>
<option value="Lampara">L√°mpara</option>
<option value="Cableado">Cableado</option>
<option value="Controlador">Controlador</option>
<option value="Estructural">Estructural</option>
</select>

<label>Actividad realizada</label>
<select id="actividad" required>
<option value="">Seleccione actividad</option>
</select>

<label>Observaciones</label>
<input type="text" id="observaciones">

<label>T√©cnico</label>
<select id="tecnico" required>
<option value="">Seleccione</option>
<option>Guanerge Salcedo</option>
<option>Luis Gutierrez</option>
<option>Juan Bola√±os</option>
<option>Jose Colmenares</option>
<option>William Orcasita</option>
</select>

<label>Foto ANTES (opcional)</label>
<input type="file" id="fotoAntes" accept="image/*" capture="environment">

<label>Foto DESPU√âS (obligatoria)</label>
<input type="file" id="fotoDespues" accept="image/*" capture="environment" required>

<button type="submit" id="btnGuardar">
  <span id="btnTexto">Guardar</span>
  <span id="spinner" style="display:none"> ‚è≥</span>
</button>

<div id="msg"></div>

</form>
</div>

<script>
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbxU1-QOWcJaY_BUn_GG0lHVNyN9BwVR6WPvD_HmzBDIPNENJKj8lfRgdV5eOQamh5U6/exec";

/* üö¶ Actividades */
const actividades = {
  Lampara:["Vehicular","Peatonal"],
  Cableado:["Vehicular","Peatonal","Acometida el√©ctrica"],
  Controlador:["Tarjetas","Reinicio","Breaker","Comunicaci√≥n","UPS","Fusible"],
  Estructural:["Postes T1","Postes T2","Sem√°foros S1","Sem√°foros S2","Bases","Anclaje","Tornillos"]
};

falla.onchange = () => {
  actividad.innerHTML = "<option value=''>Seleccione actividad</option>";
  (actividades[falla.value] || []).forEach(a=>{
    const o=document.createElement("option");
    o.textContent=a;
    actividad.appendChild(o);
  });
};

/* üíæ GUARDAR OFFLINE */
function guardarOffline(data){
  const pendientes = JSON.parse(localStorage.getItem("pendientes") || "[]");
  pendientes.push(data);
  localStorage.setItem("pendientes", JSON.stringify(pendientes));
}

/* üì§ ENVIAR FORMULARIO */
form.onsubmit = e => {
  e.preventDefault();

  btnGuardar.disabled = true;
  btnTexto.textContent = "Enviando...";
  spinner.style.display = "inline";
  msg.textContent = "";

  const leer = f => new Promise(r=>{
    if(!f) return r("");
    const fr=new FileReader();
    fr.onload=()=>r(fr.result.split(",")[1]);
    fr.readAsDataURL(f);
  });

  Promise.all([
    leer(fotoAntes.files[0]),
    leer(fotoDespues.files[0])
  ]).then(([antes,despues])=>{

    const datos = {
      fecha:fecha.value,
      direccion:direccion.value,
      falla:falla.value,
      actividad:actividad.value,
      observaciones:observaciones.value,
      tecnico:tecnico.value,
      fotoAntes:antes,
      fotoDespues:despues
    };

    // üìµ SIN INTERNET
    if(!navigator.onLine){
      guardarOffline(datos);
      msg.textContent="üìµ Sin internet. Guardado en el celular";
      msg.style.color="orange";
      form.reset();
      btnGuardar.disabled=false;
      btnTexto.textContent="Guardar";
      spinner.style.display="none";
      return;
    }

    // üì∂ CON INTERNET
    fetch(WEB_APP_URL,{
      method:"POST",
      body:JSON.stringify(datos)
    })
    .then(()=>{
      msg.textContent="‚úÖ Registro enviado";
      msg.style.color="green";
      form.reset();
    })
    .catch(()=>{
      guardarOffline(datos);
      msg.textContent="‚ö†Ô∏è Error. Guardado localmente";
      msg.style.color="orange";
    })
    .finally(()=>{
      btnGuardar.disabled=false;
      btnTexto.textContent="Guardar";
      spinner.style.display="none";
    });

  });
};

/* üîÅ REENVIAR AL VOLVER INTERNET */
window.addEventListener("online",()=>{
  const pendientes = JSON.parse(localStorage.getItem("pendientes") || "[]");
  if(pendientes.length===0) return;

  pendientes.forEach(p=>{
    fetch(WEB_APP_URL,{
      method:"POST",
      body:JSON.stringify(p)
    });
  });

  localStorage.removeItem("pendientes");
});
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
