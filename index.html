<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SGS Valledupar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="manifest" href="https://raw.githubusercontent.com/semaforosvupsys-cmd/formulario-mantenimiento/main/manifest.json?v=3" crossorigin="anonymous">
    <meta name="theme-color" content="#0f172a">
    <style>
        /* MANTENEMOS TODO TU ESTILO EXACTAMENTE IGUAL */
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #0f172a; color: #fff; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        .menu-grid { display: grid; gap: 15px; margin-top: 20px; }
        .menu-btn { padding: 25px; border-radius: 15px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; color: white; text-align: left; transition: 0.3s; display: flex; align-items: center; justify-content: space-between; }
        .menu-btn:active { transform: scale(0.98); }
        .btn-reparacion { background: #059669; border-left: 10px solid #047857; }
        .btn-pendiente { background: #3b82f6; border-left: 10px solid #1d4ed8; }
        .btn-preventivo { background: #8b5cf6; border-left: 10px solid #6d28d9; }
        .btn-laboratorio { background: #f59e0b; border-left: 10px solid #d97706; }
        .search-container { margin-top: 25px; background: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; }
        .tab-box { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 0.7rem; border: none; border-radius: 5px; cursor: pointer; background: #334155; color: #94a3b8; }
        .tab-btn.active-tab { background: #3b82f6; color: white; }
        .search-box { display: flex; gap: 8px; }
        .search-box input { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
        .btn-search { background: #64748b; border: none; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        .result-card { background: #334155; padding: 12px; border-radius: 10px; margin-top: 8px; font-size: 0.85rem; border-left: 4px solid #3b82f6; }
        .card { background: white; color: #1e293b; padding: 20px; border-radius: 20px; display: none; margin-top: 10px; }
        .active-form { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        label { display: block; margin-top: 12px; font-weight: bold; font-size: 0.9rem; color: #475569; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 16px; background: #f8fafc; }
        .btn-send { background: #0f172a; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; margin-top: 25px; font-weight: bold; cursor: pointer; }
        .btn-back { background: #f1f5f9; color: #475569; border: none; padding: 10px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; font-weight: bold; }
        .rutinas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .check-item { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 0.75rem; color: #1e293b; font-weight: 500; }
        .check-item input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; }
        .img-preview { width: 100%; border-radius: 10px; margin-top: 10px; display: none; border: 2px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="container">
  <div id="menuPrincipal">
    <div style="text-align: center; margin-bottom: 25px; padding-top: 10px;">
        <img src="https://raw.githubusercontent.com/semaforosvupsys-cmd/formulario-mantenimiento/main/icons/logo.png" 
             style="width: 100px; height: auto; border-radius: 10px; filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.5));">
        <h2 style="margin: 12px 0 0 0; font-size: 1.5rem; letter-spacing: 1px; color: #f8fafc;">SGS VALLEDUPAR</h2>
        <p style="margin: 0; color: #94a3b8; font-size: 0.85rem; font-weight: 300;">Gesti√≥n Semaf√≥rica Valledupar</p>
    </div>
    
    <div id="syncBox" style="display:none; background:#ef4444; padding:10px; border-radius:10px; margin-bottom:15px; text-align:center;">
        <p style="margin:0 0 5px 0; font-size:0.8rem;">‚ö†Ô∏è Tienes registros sin internet</p>
        <button onclick="sincronizarPendientes()" style="background:white; color:#ef4444; border:none; padding:5px 10px; border-radius:5px; font-weight:bold; cursor:pointer;">SUBIR AHORA</button>
    </div>

    <div class="menu-grid">
        <button class="menu-btn btn-pendiente" onclick="abrirForm('INVENTARIO_FALLA')">üìù INVENTARIO DE FALLA <span>‚Üí</span></button>
        <button class="menu-btn btn-reparacion" onclick="abrirForm('REPARACION')">üõ†Ô∏è REGISTRAR ARREGLO <span>‚Üí</span></button>
        <button class="menu-btn btn-laboratorio" onclick="abrirForm('LABORATORIO')">üî¨ LABORATORIO / TALLER <span>‚Üí</span></button>
        <button class="menu-btn btn-preventivo" onclick="abrirForm('PREVENTIVO')">‚úÖ MANT. PREVENTIVO <span>‚Üí</span></button>
    </div>

    <div class="search-container">
        <div class="tab-box">
            <button id="tabHist" class="tab-btn active-tab" onclick="cambiarTab('historial')">HISTORIAL</button>
            <button id="tabCont" class="tab-btn" onclick="cambiarTab('controladores')">CONTROLADORES</button>
        </div>
        <div class="search-box">
            <input type="text" id="txtBuscar" placeholder="Ej: Calle 16 o VUP-102...">
            <button class="btn-search" onclick="ejecutarBusqueda()">BUSCAR</button>
        </div>
        <div id="resultadosBusqueda"></div>
    </div>
  </div>

  <div id="pantallaForm" class="card">
        <button class="btn-back" onclick="irAlMenu()">‚Üê Volver</button>
        <h2 id="tituloSeccion" style="margin:0; color: #0f172a;"></h2>
        <form id="mainForm">
            <input type="hidden" id="tipoRegistro">
            <label>Fecha</label>
            <input type="date" id="fecha" required>
            <label>T√©cnico</label>
            <select id="tecnico" required>
                <option value="">Seleccione T√©cnico</option>
                <option>Luis Gutierrez</option><option>Guanerge Salcedo</option>
                <option>Juan Bola√±os</option><option>Jose Colmenares</option>
                <option>William Orcasita</option>
            </select>
            
            <div id="bloqueDireccion">
                <label>Ubicaci√≥n / C√≥digo VUP</label>
                <input type="text" id="direccion" placeholder="Ej: Cra 9 con Cll 16">
            </div>

            <div id="bloqueLaboratorio" style="display:none">
                <label>Componente Reparado</label>
                <select id="componenteReparado">
                    <option value="">Seleccione...</option>
                    <option>Fuentes de poder</option><option>Lamparas led</option>
                    <option>Tarjeta electronica</option><option>UPS</option>
                </select>
                <label>Tarea Realizada</label>
                <div class="rutinas-grid">
                    <div class="check-item"><input type="checkbox" class="chk-lab" value="Condensadores"> Condensadores</div>
                    <div class="check-item"><input type="checkbox" class="chk-lab" value="Resistencias"> Resistencias</div>
                    <div class="check-item"><input type="checkbox" class="chk-lab" value="Diodos"> Diodos</div>
                    <div class="check-item"><input type="checkbox" class="chk-lab" value="Soldadura"> Soldadura</div>
                    <div class="check-item"><input type="checkbox" class="chk-lab" value="Reguladores"> Reguladores</div>
                </div>
            </div>
            <div id="bloqueFallas">
                <label>Tipo de Falla</label>
                <select id="falla">
                    <option value="">Seleccione Falla</option>
                    <option value="Lampara Vehicular">L√°mpara Vehicular</option>
                    <option value="Lampara Peatonal">L√°mpara Peatonal</option>
                    <option value="Contador">Contador</option>
                    <option value="Semaforo Vehicular">Sem√°foro Vehicular</option>
                    <option value="Semaforo Peatonal">Sem√°foro Peatonal</option>
                    <option value="Semaforo de piso">Sem√°foro de piso</option>
                    <option value="Cableado">Cableado</option>
                    <option value="Controlador">Controlador</option>
                    <option value="Estructural">Estructural</option>
                    <option value="Radar de Velocidad">Radar de Velocidad</option>
                </select>
                <div id="bloqueActividad">
                    <label>Actividad Realizada</label>
                    <select id="actividad"><option value="">Seleccione Actividad</option></select>
                </div>
            </div>
            <div id="bloquePrioridad" style="display:none"><label>Prioridad</label><select id="prioridad"><option>Baja</option><option>Media</option><option>ALTA</option></select></div>
            <div id="bloquePreventivo" style="display:none">
                <label>Rutinas Realizadas</label>
                <div class="rutinas-grid">
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza Controlador"> Limpieza Controlador</div>
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Ajuste Tornillos"> Ajuste Tornillos</div>
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Ajuste Tarjetas"> Ajus. Tarjetas Elec.</div>
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza Postes"> Limpieza Postes</div>
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza Semaforos"> Limpieza Sem√°foros</div>
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Ajuste Polo Tierra"> Ajuste Polo Tierra</div>
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Pintura"> Pintura</div>
                    <div class="check-item"><input type="checkbox" class="chk-prev" value="Programacion"> Programaci√≥n</div>
                </div>
            </div>
            <label>Observaciones</label><textarea id="observaciones" rows="2"></textarea>
            <label>Foto ANTES / Evidencia</label><input type="file" id="foto1" accept="image/*" capture="camera" onchange="preview(this, 'v1')"><img id="v1" class="img-preview">
            <div id="foto2Contenedor"><label>Foto DESPU√âS / Arreglo</label><input type="file" id="foto2" accept="image/*" capture="camera" onchange="preview(this, 'v2')"><img id="v2" class="img-preview"></div>
            <button type="submit" class="btn-send" id="btnGuardar">GUARDAR REGISTRO</button>
            <div id="msgStatus" style="text-align:center; margin-top:15px; font-weight:bold"></div>
        </form>
    </div>
</div>

<script>
// EL RESTO DEL SCRIPT SIGUE EXACTAMENTE IGUAL A TU VERSI√ìN ORIGINAL
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw7YGL0nPg8PxoVPgKxWM4fzs2C538F3zJBfVIqsNXKfFfW9wUTCgk4yXvmOn3zzN0h/exec";
let coords = "Buscando GPS...";
let modoBusqueda = "historial";

navigator.geolocation.getCurrentPosition(p => coords = `${p.coords.latitude},${p.coords.longitude}`);

window.onload = () => {
    const pendientes = JSON.parse(localStorage.getItem("pendientes") || "[]");
    if(pendientes.length > 0) document.getElementById("syncBox").style.display = "block";
};

function cambiarTab(modo) {
    modoBusqueda = modo;
    document.getElementById("tabHist").classList.toggle("active-tab", modo === 'historial');
    document.getElementById("tabCont").classList.toggle("active-tab", modo === 'controladores');
    document.getElementById("resultadosBusqueda").innerHTML = "";
}

async function ejecutarBusqueda() {
    const term = document.getElementById("txtBuscar").value.toLowerCase();
    const resDiv = document.getElementById("resultadosBusqueda");
    
    resDiv.innerHTML = "<div class='result-card'>‚åõ Consultando Base de Datos...</div>";
    
    const q = (modoBusqueda === 'historial') 
        ? `getPendientesAbiertos=true&filtro=${encodeURIComponent(term)}` 
        : `getControladores=true&filtro=${encodeURIComponent(term)}`;
        
    try {
        const r = await fetch(`${WEB_APP_URL}?${q}`);
        const data = await r.json();
        resDiv.innerHTML = "";

        if(!data || data.length === 0) {
            resDiv.innerHTML = "<div class='result-card'>‚úÖ Sin registros pendientes</div>";
            return;
        }

        data.forEach(item => {
            if(modoBusqueda === 'historial') {
                resDiv.innerHTML += `
                    <div class="result-card" style="border-left: 5px solid #ef4444; background: #1e293b; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="color:#ef4444; font-weight:bold; font-size:0.75rem;">‚ö†Ô∏è PENDIENTE</span>
                            <small style="color:#94a3b8">${item.prioridad || ''}</small>
                        </div>
                        <strong style="font-size:1rem; color:white;">${item.direccion}</strong><br>
                        <span style="color:#cbd5e1; font-size:0.8rem;">Falla: ${item.falla}</span><br>
                        <small style="color:#94a3b8">Reportado: ${item.fecha}</small>
                        <button onclick="llenarArreglo('${item.direccion}')" style="width:100%; margin-top:10px; padding:10px; background:#059669; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                            üõ†Ô∏è REGISTRAR ARREGLO
                        </button>
                    </div>`;
            } else {
                resDiv.innerHTML += `
                    <div class="result-card" style="border-left: 5px solid #3b82f6;">
                        <strong style="color:#3b82f6; font-size:1rem;">${item.codigo}</strong><br>
                        <small style="color:#fff;">${item.direccion}</small>
                    </div>`;
            }
        });
    } catch (e) { 
        resDiv.innerHTML = "<div class='result-card' style='border-left-color:#ef4444'>‚ö†Ô∏è Requiere Conexi√≥n</div>"; 
    }
}

function llenarArreglo(dir) {
    abrirForm('REPARACION');
    document.getElementById("direccion").value = dir;
}

const diccionarioActividades = {
    "Lampara Vehicular": ["M√≥dulo LED", "Contador", "Limpieza"],
    "Lampara Peatonal": ["M√≥dulo LED", "Limpieza"],
    "Semaforo Vehicular": ["Estructural", "Bases(Patos)", "Visera" ,"Limpieza"],
    "Semaforo Peatonal": ["Estructural", "Bases", "Visera", "Limpieza"],
    "Semaforo de piso": ["Mantenimiento LED", "Policarbonato", "Resina"],
    "Cableado": ["Vehicular", "Peatonal", "Acometida"],
    "Controlador": ["Tarjetas", "Reinicio", "Breaker", "Modem", "Timer o Ventilador", "UPS", "Fusible", "Polo Tierra"],
    "Estructural": ["Poste T1/T2", "Anclaje", "Torniller√≠a", "Pintura","Reja"],
    "Radar de Velocidad": ["Bater√≠as", "Panel Solar", "Panel de Control", "Controlador"]
};

document.getElementById("falla").onchange = (e) => {
    const actSel = document.getElementById("actividad");
    actSel.innerHTML = "<option value=''>Seleccione Actividad</option>";
    if(diccionarioActividades[e.target.value]) {
        diccionarioActividades[e.target.value].forEach(a => {
            let o = document.createElement("option"); o.value = o.textContent = a; actSel.appendChild(o);
        });
    }
};

function abrirForm(tipo) {
    document.getElementById("menuPrincipal").style.display = "none";
    document.getElementById("pantallaForm").classList.add("active-form");
    document.getElementById("tipoRegistro").value = tipo;
    document.getElementById("tituloSeccion").textContent = tipo.replace(/_/g, ' ');
    document.getElementById("bloqueDireccion").style.display = (tipo === "LABORATORIO") ? "none" : "block";
    document.getElementById("bloqueFallas").style.display = (tipo === "REPARACION" || tipo === "INVENTARIO_FALLA") ? "block" : "none";
    document.getElementById("bloqueActividad").style.display = (tipo === "REPARACION") ? "block" : "none";
    document.getElementById("bloquePrioridad").style.display = (tipo === "INVENTARIO_FALLA") ? "block" : "none";
    document.getElementById("bloquePreventivo").style.display = (tipo === "PREVENTIVO") ? "block" : "none";
    document.getElementById("bloqueLaboratorio").style.display = (tipo === "LABORATORIO") ? "block" : "none";
    document.getElementById("foto2Contenedor").style.display = (tipo === "INVENTARIO_FALLA") ? "none" : "block";
    const btn = document.getElementById("btnGuardar");
    btn.style.background = (tipo === "PREVENTIVO") ? "#8b5cf6" : (tipo === "LABORATORIO") ? "#f59e0b" : "#0f172a";
}

function irAlMenu() {
    document.getElementById("pantallaForm").classList.remove("active-form");
    document.getElementById("menuPrincipal").style.display = "block";
}

function preview(input, id) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => { const img = document.getElementById(id); img.src = e.target.result; img.style.display = 'block'; }
        reader.readAsDataURL(input.files[0]);
    }
}

async function procesarFoto(file) {
    if(!file) return "";
    return new Promise(res => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const MAX = 800;
                let w = img.width, h = img.height;
                if (w > h && w > MAX) { h *= MAX/w; w = MAX; }
                else if (h > MAX) { w *= MAX/h; h = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                res(canvas.toDataURL("image/jpeg", 0.6).split(",")[1]);
            };
        };
    });
}

document.getElementById("mainForm").onsubmit = async e => {
    e.preventDefault();
    const btn = document.getElementById("btnGuardar");
    const msg = document.getElementById("msgStatus");
    const tipo = document.getElementById("tipoRegistro").value;
    btn.disabled = true;
    msg.textContent = "‚è≥ Procesando...";

    let actividadFinal = document.getElementById("actividad").value;
    let fallaFinal = document.getElementById("falla").value;
    let direccionFinal = document.getElementById("direccion").value;

    if(tipo === "LABORATORIO") {
        fallaFinal = document.getElementById("componenteReparado").value;
        actividadFinal = Array.from(document.querySelectorAll('.chk-lab:checked')).map(cb => cb.value).join(', ');
        direccionFinal = "Taller"; 
    } else if(tipo === "PREVENTIVO") {
        actividadFinal = Array.from(document.querySelectorAll('.chk-prev:checked')).map(cb => cb.value).join(', ');
    }

    const datos = {
        id: "VUP-" + Date.now(),
        tipo: tipo,
        fecha: document.getElementById("fecha").value,
        tecnico: document.getElementById("tecnico").value,
        direccion: direccionFinal,
        falla: fallaFinal,
        actividad: actividadFinal,
        prioridad: document.getElementById("prioridad").value,
        observaciones: document.getElementById("observaciones").value,
        coords: coords,
        foto1: await procesarFoto(document.getElementById("foto1").files[0]),
        foto2: await procesarFoto(document.getElementById("foto2").files[0])
    };

    if (navigator.onLine) {
        try {
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(datos) });
            msg.innerHTML = "‚úÖ ENVIADO EXITOSAMENTE";
            setTimeout(() => location.reload(), 2000);
        } catch(err) { guardarEnLocal(datos); }
    } else {
        guardarEnLocal(datos);
    }
};

function guardarEnLocal(datos) {
    let pendientes = JSON.parse(localStorage.getItem("pendientes") || "[]");
    pendientes.push(datos);
    localStorage.setItem("pendientes", JSON.stringify(pendientes));
    alert("‚ö†Ô∏è Sin internet. Guardado en el celular. Sincroniza al tener se√±al.");
    location.reload();
}

async function sincronizarPendientes() {
    const pendientes = JSON.parse(localStorage.getItem("pendientes") || "[]");
    const syncBtn = document.querySelector("#syncBox button");
    syncBtn.disabled = true;
    syncBtn.textContent = "Subiendo...";

    for (let i = 0; i < pendientes.length; i++) {
        try {
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(pendientes[i]) });
        } catch (e) { break; }
    }
    localStorage.removeItem("pendientes");
    alert("‚úÖ Todos los registros sincronizados.");
    location.reload();
}
</script>
</body>
</html>
