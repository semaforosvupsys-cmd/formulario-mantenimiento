<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mantenimiento Semaf√≥rico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{background:#0f172a;padding:15px;font-family:system-ui}
.card{background:white;max-width:420px;margin:auto;padding:20px;border-radius:16px}
label{font-weight:600;margin-top:12px;display:block}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #d1d5db;
}
button{background:#059669;color:white;font-weight:bold;border:none}
button:disabled{background:#9ca3af}
#msg{text-align:center;margin-top:10px;font-weight:bold}
</style>
</head>

<body>

<div class="card">
<h2>üö¶ Registro Mantenimiento</h2>

<form id="form">

<label>Fecha</label>
<input type="date" id="fecha" required>

<label>Intersecci√≥n</label>
<input type="text" id="direccion" required>

<label>Tipo de falla</label>
<select id="falla" required>
<option value="">Seleccione</option>
<option>Lampara</option>
<option>Cableado</option>
<option>Controlador</option>
<option>Estructural</option>
</select>

<label>Actividad realizada</label>
<select id="actividad" required disabled>
<option value="">Seleccione actividad</option>
</select>

<label>Observaciones</label>
<input type="text" id="observaciones">

<label>T√©cnico</label>
<select id="tecnico" required>
<option value="">Seleccione</option>
<option>Luis Gutierrez</option>
<option>Jose Colmenares</option>
</select>

<label>Foto ANTES</label>
<input type="file" id="fotoAntes" accept="image/*">

<label>Foto DESPU√âS</label>
<input type="file" id="fotoDespues" accept="image/*" required>

<button id="btnGuardar">
<span id="btnTexto">Guardar</span>
<span id="spinner" style="display:none"> ‚è≥</span>
</button>

<div id="msg"></div>

</form>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxU1-QOWcJaY_BUn_GG0lHVNyN9BwVR6WPvD_HmzBDIPNENJKj8lfRgdV5eOQamh5U6/exec";

let enviando = false;

/* ACTIVIDADES */
const actividades = {
  Lampara:["Vehicular","Peatonal"],
  Cableado:["Vehicular","Peatonal","Acometida el√©ctrica"],
  Controlador:["Tarjetas","Reinicio","Breaker","Comunicaci√≥n","UPS"],
  Estructural:["Postes","Sem√°foros","Bases","Anclaje"]
};

falla.onchange = ()=>{
  actividad.innerHTML="<option value=''>Seleccione actividad</option>";
  actividad.disabled=true;
  if(!falla.value) return;
  actividades[falla.value].forEach(a=>{
    const o=document.createElement("option");
    o.value=o.textContent=a;
    actividad.appendChild(o);
  });
  actividad.disabled=false;
};

/* GUARDAR OFFLINE */
function guardarOffline(data){
  const p = JSON.parse(localStorage.getItem("pendientes") || "[]");
  p.push(data);
  localStorage.setItem("pendientes", JSON.stringify(p));
}

/* LEER IMAGEN */
const leer = f => new Promise(r=>{
  if(!f) return r("");
  const fr=new FileReader();
  fr.onload=()=>r(fr.result.split(",")[1]);
  fr.readAsDataURL(f);
});

/* SUBMIT */
form.onsubmit = async e=>{
  e.preventDefault();
  if(enviando) return;
  enviando=true;

  btnGuardar.disabled=true;
  btnTexto.textContent="Enviando...";
  spinner.style.display="inline";
  msg.textContent="";

  const datos = {
    fecha:fecha.value,
    direccion:direccion.value,
    falla:falla.value,
    actividad:actividad.value,
    observaciones:observaciones.value,
    tecnico:tecnico.value,
    fotoAntes: await leer(fotoAntes.files[0]),
    fotoDespues: await leer(fotoDespues.files[0])
  };

  /* üìµ OFFLINE ‚Üí SOLO GUARDA */
  if(!navigator.onLine){
    guardarOffline(datos);
    msg.textContent="üìµ Guardado sin internet";
    msg.style.color="orange";
    reset();
    return;
  }

  /* üì∂ ONLINE ‚Üí ENV√çA */
  fetch(WEB_APP_URL,{
    method:"POST",
    body:JSON.stringify(datos)
  })
  .then(()=>{
    msg.textContent="‚úÖ Enviado";
    msg.style.color="green";
  })
  .catch(()=>{
    guardarOffline(datos);
    msg.textContent="‚ö†Ô∏è Guardado localmente";
    msg.style.color="orange";
  })
  .finally(reset);
};

/* üîÅ REENV√çO CONTROLADO */
window.addEventListener("online", async ()=>{
  const p = JSON.parse(localStorage.getItem("pendientes") || "[]");
  if(!p.length) return;

  for(const d of p){
    await fetch(WEB_APP_URL,{
      method:"POST",
      body:JSON.stringify(d)
    });
  }
  localStorage.removeItem("pendientes");
});

/* RESET SEGURO */
function reset(){
  enviando=false;
  btnGuardar.disabled=false;
  btnTexto.textContent="Guardar";
  spinner.style.display="none";
  form.reset();
  actividad.disabled=true;
}
</script>

</body>
</html>
