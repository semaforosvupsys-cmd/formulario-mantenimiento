<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mantenimiento VUP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <?!= HtmlService.createTemplateFromFile('manifest').evaluate().getContent() ?>
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VUP App">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/semaforosvupsys-cmd/formulario-mantenimiento/main/icons/icon-192.png">

    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #0f172a; color: #fff; padding: 15px; margin: 0; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 450px; margin: auto; }
        
        /* Estilo de botones del Men√∫ */
        .menu-grid { display: grid; gap: 15px; margin-top: 25px; }
        .menu-btn { 
            padding: 22px; border-radius: 18px; border: none; font-weight: bold; 
            font-size: 1rem; cursor: pointer; color: white; text-align: left;
            transition: transform 0.2s, active 0.2s; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .menu-btn:active { transform: scale(0.97); }
        
        .btn-reparacion { background: linear-gradient(135deg, #059669, #047857); border-left: 8px solid #064e3b; }
        .btn-inventario { background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-left: 8px solid #1e3a8a; }
        .btn-preventivo { background: linear-gradient(135deg, #8b5cf6, #6d28d9); border-left: 8px solid #4c1d95; }
        .btn-controlador { background: linear-gradient(135deg, #475569, #1e293b); border-left: 8px solid #0f172a; }

        /* Tarjetas de Formulario */
        .card { background: #ffffff; color: #1e293b; padding: 25px; border-radius: 24px; display: none; margin-top: 10px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); }
        .active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes slideUp { 
            from { transform: translateY(30px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }

        label { display: block; margin-top: 15px; font-weight: 700; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; padding: 14px; margin-top: 6px; border-radius: 12px; 
            border: 1px solid #e2e8f0; font-size: 16px; background: #f8fafc;
        }
        input:focus { outline: 2px solid #3b82f6; border-color: transparent; }
        
        .check-item { display: flex; align-items: center; gap: 12px; background: #f1f5f9; padding: 12px; border-radius: 10px; margin-top: 8px; }
        .check-item input { width: 20px; height: 20px; margin: 0; cursor: pointer; }

        .btn-send { width: 100%; padding: 18px; margin-top: 25px; border-radius: 14px; border: none; background: #0f172a; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-back { background: #f1f5f9; border: none; padding: 10px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 15px; color: #475569; }
        
        .item-ctrl { padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s; }
        .item-ctrl:hover { background: #f8fafc; }
        .modelo-tag { background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .img-prev { width: 100%; border-radius: 12px; margin-top: 12px; display: none; border: 2px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="container">
    <div id="seccionMenu">
        <h2 style="text-align: center; margin-top: 30px; letter-spacing: -1px;">üö¶ Sistema VUP</h2>
        <p style="text-align: center; color: #94a3b8; font-size: 0.9rem; margin-top: -10px;">Gesti√≥n de Mantenimiento</p>
        
        <div class="menu-grid">
            <button class="menu-btn btn-reparacion" onclick="abrirForm('REPARACION')">üõ†Ô∏è REGISTRAR ARREGLO <span>‚Üí</span></button>
            <button class="menu-btn btn-inventario" onclick="abrirForm('INVENTARIO_FALLA')">üìù INVENTARIO FALLA <span>‚Üí</span></button>
            <button class="menu-btn btn-preventivo" onclick="abrirForm('PREVENTIVO')">‚úÖ MANT. PREVENTIVO <span>‚Üí</span></button>
            <button class="menu-btn btn-controlador" onclick="abrirLista()">üîç LISTA EQUIPOS <span>‚Üí</span></button>
        </div>
    </div>

    <div id="seccionLista" class="card">
        <button class="btn-back" onclick="irAlMenu()">‚Üê Volver</button>
        <h3 style="margin:0">Equipos Registrados</h3>
        <input type="text" id="busquedaCtrl" placeholder="Buscar por c√≥digo o direcci√≥n..." onkeyup="filtrarCtrl()">
        <div id="listaCuerpo" style="margin-top:15px; max-height:450px; overflow-y:auto;"></div>
    </div>

    <div id="seccionForm" class="card">
        <button class="btn-back" onclick="irAlMenu()">‚Üê Volver</button>
        <h3 id="tituloForm" style="margin:0; color:#0f172a; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;"></h3>
        
        <form id="mainForm">
            <input type="hidden" id="tipoRegistro">
            
            <label>Fecha del Trabajo</label>
            <input type="date" id="fecha" required>

            <label>T√©cnico Encargado</label>
            <select id="tecnico" required>
                <option value="">Seleccione T√©cnico</option>
                <option>Luis Gutierrez</option>
                <option>Guanerge Salcedo</option>
                <option>Juan Bola√±os</option>
                <option>Jose Colmenares</option>
                <option>William Orcasita</option>
            </select>

            <label>Ubicaci√≥n / C√≥digo Equipo</label>
            <input type="text" id="direccion" placeholder="Ej: VUP-001" required>

            <div id="bloqueFallas">
                <label>Tipo de Falla Detectada</label>
                <select id="falla">
                    <option value="">Seleccione Falla</option>
                    <option value="Lampara Vehicular">L√°mpara Vehicular</option>
                    <option value="Lampara Peatonal">L√°mpara Peatonal</option>
                    <option value="Controlador">Controlador</option>
                    <option value="Semaforo de piso">Sem√°foro de piso</option>
                    <option value="Cableado">Cableado</option>
                    <option value="Estructural">Estructural</option>
                </select>

                <div id="bloqueActividad">
                    <label>Acci√≥n Realizada</label>
                    <select id="actividad"><option value="">Seleccione actividad</option></select>
                </div>
            </div>

            <div id="bloquePrioridad" style="display:none">
                <label>Nivel de Urgencia</label>
                <select id="prioridad">
                    <option value="Baja">Baja</option>
                    <option value="Media">Media</option>
                    <option value="ALTA / URGENTE">ALTA / URGENTE</option>
                </select>
            </div>

            <div id="bloquePreventivo" style="display:none">
                <label>Rutinas Completadas</label>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza de lamparas"> Limpieza de l√°mparas</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza de sem√°foros"> Limpieza de sem√°foros</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza de postes"> Limpieza de postes</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza de controlador"> Limpieza de controlador</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Ajustes de torniller√≠a"> Ajustes de torniller√≠a</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Pintura"> Pintura</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Soldadura"> Soldadura</div>
            </div>

            <label>Observaciones Adicionales</label>
            <textarea id="observaciones" rows="3" placeholder="Detalles del trabajo..."></textarea>

            <label>Evidencia: Antes</label>
            <input type="file" id="foto1" accept="image/*" onchange="prev(this, 'p1')">
            <img id="p1" class="img-prev">

            <div id="foto2Contenedor">
                <label>Evidencia: Despu√©s</label>
                <input type="file" id="foto2" accept="image/*" onchange="prev(this, 'p2')">
                <img id="p2" class="img-prev">
            </div>

            <button type="submit" class="btn-send" id="btnGuardar">GUARDAR EN SISTEMA</button>
            <div id="status" style="text-align:center; margin-top:15px; font-weight:bold; font-size: 0.9rem;"></div>
        </form>
    </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyQu4zCWkSamL2-oHLPqPmze43-a7p7snIGTl8U_xUbn3mFz2-RpQUp1M2t3iZDjOKP/exec";
let maestra = [];

/* --- REGISTRO DEL SERVICE WORKER --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('https://raw.githubusercontent.com/semaforosvupsys-cmd/formulario-mantenimiento/main/sw.js', { scope: '/' })
      .then(reg => console.log('PWA Lista'))
      .catch(err => console.log('Error PWA:', err));
  });
}

function irAlMenu() {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    document.getElementById('seccionMenu').style.display = 'block';
    window.scrollTo(0,0);
}

function abrirForm(tipo) {
    document.getElementById('seccionMenu').style.display = 'none';
    document.getElementById('seccionForm').classList.add('active');
    document.getElementById('tipoRegistro').value = tipo;
    document.getElementById('tituloForm').textContent = tipo.replace(/_/g, ' ');

    document.getElementById("bloqueFallas").style.display = (tipo !== "PREVENTIVO") ? "block" : "none";
    document.getElementById("bloqueActividad").style.display = (tipo === "REPARACION") ? "block" : "none";
    document.getElementById("bloquePrioridad").style.display = (tipo === "INVENTARIO_FALLA") ? "block" : "none";
    document.getElementById("bloquePreventivo").style.display = (tipo === "PREVENTIVO") ? "block" : "none";
    document.getElementById("foto2Contenedor").style.display = (tipo === "INVENTARIO_FALLA") ? "none" : "block";
}

async function abrirLista() {
    document.getElementById('seccionMenu').style.display = 'none';
    document.getElementById('seccionLista').classList.add('active');
    if(maestra.length === 0) {
        document.getElementById('listaCuerpo').innerHTML = "<p style='color:#64748b; text-align:center;'>Cargando base de datos...</p>";
        try {
            const res = await fetch(`${WEB_APP_URL}?getControladores=true`);
            maestra = await res.json();
            renderCtrl(maestra);
        } catch(e) {
            document.getElementById('listaCuerpo').innerHTML = "Error al cargar equipos.";
        }
    }
}

function renderCtrl(datos) {
    document.getElementById('listaCuerpo').innerHTML = datos.map(c => `
        <div class="item-ctrl" onclick="seleccionarCtrl('${c.codigo}', '${c.direccion}')">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b>${c.codigo}</b>
                <span class="modelo-tag">${c.modelo || 'N/A'}</span>
            </div>
            <small style="color:#64748b">${c.direccion}</small>
        </div>
    `).join('');
}

function seleccionarCtrl(cod, dir) {
    abrirForm('REPARACION');
    document.getElementById('seccionLista').classList.remove('active');
    document.getElementById('direccion').value = cod + " - " + dir;
}

function filtrarCtrl() {
    const t = document.getElementById('busquedaCtrl').value.toLowerCase();
    renderCtrl(maestra.filter(x => x.codigo.toLowerCase().includes(t) || x.direccion.toLowerCase().includes(t)));
}

const actividades = {
    "Lampara Vehicular": ["Cambio LED", "Limpieza", "Revisi√≥n Conexi√≥n", "Cambio Policarbonato"],
    "Controlador": ["Cambio Tarjeta CPU", "Reinicio Sistema", "Ajuste Breaker", "Fusible Quemado", "Programaci√≥n"],
    "Semaforo de piso": ["M√≥dulo LED", "Policarbonato", "Resina Ep√≥xica", "Limpieza"],
    "Cableado": ["Reparaci√≥n Vehicular", "Reparaci√≥n Peatonal", "Acometida El√©ctrica", "Caja de Inspecci√≥n"],
    "Estructural": ["Poste Inclinado", "Base Suelta", "Pintura General", "Soldadura Soporte"]
};

document.getElementById('falla').onchange = (e) => {
    const act = document.getElementById('actividad');
    act.innerHTML = "<option value=''>Seleccione Acci√≥n</option>";
    (actividades[e.target.value] || []).forEach(a => {
        let o = document.createElement("option"); o.value = o.textContent = a; act.appendChild(o);
    });
};

function prev(input, id) {
    if (input.files && input.files[0]) {
        const r = new FileReader();
        r.onload = e => { const i = document.getElementById(id); i.src = e.target.result; i.style.display = "block"; }
        r.readAsDataURL(input.files[0]);
    }
}

document.getElementById('mainForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnGuardar');
    btn.disabled = true;
    const status = document.getElementById('status');
    status.style.color = "#3b82f6";
    status.textContent = "‚åõ Procesando y subiendo fotos...";

    const checks = document.querySelectorAll('.chk-prev:checked');
    let listaPreventivos = Array.from(checks).map(cb => cb.value).join(", ");

    const base64 = f => new Promise(r => {
        if(!f) return r("");
        const reader = new FileReader();
        reader.onload = () => r(reader.result.split(",")[1]);
        reader.readAsDataURL(f);
    });

    const datos = {
        id: "VUP-" + Date.now(),
        tipo: document.getElementById('tipoRegistro').value,
        fecha: document.getElementById('fecha').value,
        tecnico: document.getElementById('tecnico').value,
        direccion: document.getElementById('direccion').value,
        falla: document.getElementById('falla').value,
        actividad: document.getElementById('actividad').value,
        prioridad: document.getElementById('prioridad').value,
        actividad_preventiva: listaPreventivos,
        observaciones: document.getElementById('observaciones').value,
        foto1: await base64(document.getElementById('foto1').files[0]),
        foto2: await base64(document.getElementById('foto2').files[0])
    };

    try {
        await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(datos) });
        status.style.color = "#059669";
        status.textContent = "‚úÖ Guardado correctamente en la nube.";
        setTimeout(() => { location.reload(); }, 2500);
    } catch (err) {
        status.style.color = "#ef4444";
        status.textContent = "‚ùå Error al guardar. Revise su conexi√≥n.";
        btn.disabled = false;
    }
};
</script>
</body>
</html>
