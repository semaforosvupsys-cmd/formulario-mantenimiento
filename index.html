<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mantenimiento Semaf√≥rico VUP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <?!= HtmlService.createTemplateFromFile('manifest').evaluate().getContent() ?>
    
    <meta name="theme-color" content="#0f172a">
    <style>
        /* Mantengo tus estilos originales y a√±ado los de la lista */
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #0f172a; color: #fff; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        
        .menu-grid { display: grid; gap: 15px; margin-top: 20px; }
        .menu-btn { 
            padding: 25px; border-radius: 15px; border: none; font-weight: bold; 
            font-size: 1.1rem; cursor: pointer; color: white; text-align: left;
            transition: 0.3s; display: flex; align-items: center; justify-content: space-between;
        }
        .btn-reparacion { background: #059669; border-left: 10px solid #047857; }
        .btn-pendiente { background: #3b82f6; border-left: 10px solid #1d4ed8; }
        .btn-preventivo { background: #8b5cf6; border-left: 10px solid #6d28d9; }
        .btn-controlador { background: #475569; border-left: 10px solid #1e293b; }

        .search-container { margin-top: 25px; background: #1e293b; padding: 15px; border-radius: 15px; }
        .search-box { display: flex; gap: 8px; }
        .search-box input { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
        
        .card { background: white; color: #1e293b; padding: 20px; border-radius: 20px; display: none; margin-top: 10px; }
        .active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        label { display: block; margin-top: 12px; font-weight: bold; font-size: 0.9rem; color: #475569; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 16px; }
        
        .btn-send { background: #0f172a; color: white; border: none; padding: 16px; width: 100%; border-radius: 10px; margin-top: 25px; font-weight: bold; cursor: pointer; }
        .btn-back { background: #f1f5f9; color: #475569; border: none; padding: 10px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; font-weight: bold; }
        
        /* Estilos lista controladores */
        .item-ctrl { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-ctrl b { display: block; color: #0f172a; }
        .item-ctrl small { color: #64748b; }
        .modelo-tag { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }
        .offline-alert { background: #f59e0b; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="offlineAlert" class="offline-alert">‚ö†Ô∏è Tienes reportes pendientes por subir</div>

    <div id="menuPrincipal">
        <h2 style="text-align: center; margin-bottom: 20px;">Gesti√≥n de Tr√°nsito VUP</h2>
        
        <div class="menu-grid">
            <button class="menu-btn btn-reparacion" onclick="abrirForm('REPARACION')">üõ†Ô∏è REGISTRAR ARREGLO <span>‚Üí</span></button>
            <button class="menu-btn btn-pendiente" onclick="abrirForm('INVENTARIO_FALLA')">üìù INVENTARIO DE FALLA <span>‚Üí</span></button>
            <button class="menu-btn btn-preventivo" onclick="abrirForm('PREVENTIVO')">‚úÖ MANT. PREVENTIVO <span>‚Üí</span></button>
            <button class="menu-btn btn-controlador" onclick="abrirControladores()">üîç LISTA CONTROLADORES <span>‚Üí</span></button>
        </div>

        <div class="search-container">
            <p style="margin: 0 0 10px 0; font-size: 0.9rem; font-weight: bold; color: #94a3b8;">üîç BUSCAR HISTORIAL POR DIRECCI√ìN</p>
            <div class="search-box">
                <input type="text" id="txtBuscar" placeholder="Ej: Av. Fundaci√≥n o Cra 12">
                <button class="btn-send" style="margin:0; width:auto; padding:10px 15px" onclick="buscarHistorial()">BUSCAR</button>
            </div>
            <div id="resultadosBusqueda"></div>
        </div>
    </div>

    <div id="pantallaLista" class="card">
        <button class="btn-back" onclick="irAlMenu()">‚Üê Volver</button>
        <h3 style="margin:0; color:#0f172a">Inventario de Equipos</h3>
        <input type="text" id="busquedaCtrl" placeholder="Filtrar por c√≥digo o direcci√≥n..." onkeyup="filtrarCtrl()" style="margin-bottom:10px">
        <div id="listaCuerpo" style="max-height:400px; overflow-y:auto;"></div>
    </div>

    <div id="pantallaForm" class="card">
        <button class="btn-back" onclick="irAlMenu()">‚Üê Volver al Men√∫</button>
        <h2 id="tituloSeccion" style="margin:0; color: #0f172a;"></h2>
        
        <form id="mainForm">
            <input type="hidden" id="tipoRegistro">
            <label>Fecha del Trabajo</label>
            <input type="date" id="fecha" required>

            <label>T√©cnico</label>
            <select id="tecnico" required>
                <option value="">Seleccione T√©cnico</option>
                <option>Luis Gutierrez</option>
                <option>Guanerge Salcedo</option>
                <option>Juan Bola√±os</option>
                <option>Jose Colmenares</option>
                <option>William Orcasita</option>
            </select>

            <label>Ubicaci√≥n / Intersecci√≥n</label>
            <input type="text" id="direccion" placeholder="Ej: VUP-001 o Av. Fundaci√≥n" required>

            <div id="bloqueFallas">
                <label>Tipo de Falla</label>
                <select id="falla">
                    <option value="">Seleccione Falla</option>
                    <option value="Lampara Vehicular">L√°mpara Vehicular</option>
                    <option value="Lampara Peatonal">L√°mpara Peatonal</option>
                    <option value="Semaforo Vehicular">Sem√°foro Vehicular</option>
                    <option value="Semaforo Peatonal">Sem√°foro Peatonal</option>
                    <option value="Semaforo de piso">Sem√°foro de piso</option>
                    <option value="Cableado">Cableado</option>
                    <option value="Controlador">Controlador</option>
                    <option value="Estructural">Estructural</option>
                    <option value="Radar de Velocidad">Radar de Velocidad</option>
                </select>

                <div id="bloqueActividad">
                    <label>Actividad Realizada</label>
                    <select id="actividad">
                        <option value="">Seleccione Actividad</option>
                    </select>
                </div>
            </div>

            <div id="bloquePrioridad" style="display:none">
                <label>Prioridad del Arreglo</label>
                <select id="prioridad">
                    <option value="Baja">Baja</option>
                    <option value="Media">Media</option>
                    <option value="ALTA / URGENTE">ALTA / URGENTE</option>
                </select>
            </div>

            <div id="bloquePreventivo" style="display:none">
                <label>Rutinas Realizadas</label>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Limpieza de lamparas"> Limpieza de l√°mparas</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Ajustes de torniller√≠a"> Ajustes de torniller√≠a</div>
                <div class="check-item"><input type="checkbox" class="chk-prev" value="Pintura"> Pintura</div>
            </div>

            <label>Observaciones</label>
            <textarea id="observaciones" rows="2" placeholder="Notas adicionales..."></textarea>

            <label>Foto Antes / Evidencia</label>
            <input type="file" id="foto1" accept="image/*">
            
            <div id="foto2Contenedor">
                <label>Foto Despu√©s</label>
                <input type="file" id="foto2" accept="image/*">
            </div>

            <button type="submit" class="btn-send" id="btnGuardar">GUARDAR REGISTRO</button>
            <div id="msgStatus" style="text-align:center; margin-top:15px; font-weight:bold"></div>
        </form>
    </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzGAYQI89mRwdp0QRD0FSD-61HIDifHllyaDXSzKm5ftt1tCj0-wOJMRdM-Sr0vfttK/exec"; 
let coords = "0,0";
let maestraControladores = [];

navigator.geolocation.getCurrentPosition(p => coords = `${p.coords.latitude},${p.coords.longitude}`);

/* --- L√ìGICA DE CONTROLADORES --- */
async function abrirControladores() {
    document.getElementById("menuPrincipal").style.display = "none";
    document.getElementById("pantallaLista").classList.add("active");
    const cuerpo = document.getElementById('listaCuerpo');
    
    if(maestraControladores.length === 0) {
        cuerpo.innerHTML = "‚åõ Cargando equipos...";
        const res = await fetch(`${WEB_APP_URL}?getControladores=true`);
        maestraControladores = await res.json();
    }
    renderCtrl(maestraControladores);
}

function renderCtrl(datos) {
    document.getElementById('listaCuerpo').innerHTML = datos.map(c => `
        <div class="item-ctrl" onclick="seleccionarCtrl('${c.codigo}', '${c.direccion}')">
            <b>${c.codigo} <span class="modelo-tag">${c.modelo || 'S/M'}</span></b>
            <small>${c.direccion}</small>
        </div>
    `).join('');
}

function filtrarCtrl() {
    const term = document.getElementById('busquedaCtrl').value.toLowerCase();
    renderCtrl(maestraControladores.filter(x => x.codigo.toLowerCase().includes(term) || x.direccion.toLowerCase().includes(term)));
}

function seleccionarCtrl(cod, dir) {
    if(confirm("¬øIniciar reporte para " + cod + "?")) {
        abrirForm('REPARACION');
        document.getElementById('direccion').value = cod + " - " + dir;
        document.getElementById("pantallaLista").classList.remove("active");
    }
}

/* --- L√ìGICA FORMULARIO Y BUSQUEDA --- */
async function buscarHistorial() {
    const term = document.getElementById("txtBuscar").value;
    const resDiv = document.getElementById("resultadosBusqueda");
    resDiv.innerHTML = "‚åõ Buscando...";
    const response = await fetch(`${WEB_APP_URL}?buscar=${term}`);
    const data = await response.json();
    resDiv.innerHTML = data.length ? "" : "Sin resultados.";
    data.forEach(item => {
        resDiv.innerHTML += `<div style="background:#334155; padding:8px; border-radius:8px; margin-top:5px; font-size:0.8rem">
            <b>${item.fecha}</b> - ${item.tipo}<br>${item.actividad}</div>`;
    });
}

const diccionarioActividades = {
    "Lampara Vehicular": ["Cambio de m√≥dulo LED", "Limpieza", "Revisi√≥n"],
    "Controlador": ["Cambio de tarjetas", "Reinicio", "UPS", "Fusible"],
    "Semaforo de piso": ["Mantenimiento m√≥dulo", "Cambio policarbonato", "Sello resina"]
    // ... a√±ade las dem√°s que necesites
};

document.getElementById("falla").onchange = (e) => {
    const actSel = document.getElementById("actividad");
    actSel.innerHTML = "<option value=''>Seleccione Actividad</option>";
    (diccionarioActividades[e.target.value] || []).forEach(a => {
        let o = document.createElement("option"); o.value = o.textContent = a; actSel.appendChild(o);
    });
};

function abrirForm(tipo) {
    document.getElementById("menuPrincipal").style.display = "none";
    document.getElementById("pantallaForm").classList.add("active");
    document.getElementById("tipoRegistro").value = tipo;
    document.getElementById("tituloSeccion").textContent = tipo.replace(/_/g, ' ');
    document.getElementById("bloqueFallas").style.display = (tipo !== "PREVENTIVO") ? "block" : "none";
    document.getElementById("bloquePrioridad").style.display = (tipo === "INVENTARIO_FALLA") ? "block" : "none";
    document.getElementById("bloquePreventivo").style.display = (tipo === "PREVENTIVO") ? "block" : "none";
}

function irAlMenu() {
    document.getElementById("pantallaForm").classList.remove("active");
    document.getElementById("pantallaLista").classList.remove("active");
    document.getElementById("menuPrincipal").style.display = "block";
}

// ... Mant√©n tus funciones procesarFoto, finalizarEnvio y Sincronizaci√≥n offline igual ...
</script>
</body>
</html>
